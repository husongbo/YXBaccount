<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>我要充值</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta name="misapplication-tap-highlight" content="no" />
    <meta name="HandheldFriendly" content="true" />
    <meta name="MobileOptimized" content="320" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-control" content="no-cache" />
    <meta http-equiv="Cache" content="no-cache" />

    <link rel="stylesheet" href="../Common/css/sm.css" />
    <link rel="stylesheet" href="../Common/css/iosSelect.css">
    

    <script type="text/javascript" src="../Common/js/zepto.js"></script>
    <script type="text/javascript" src="../Common/js/iosSelect.js"></script>
    <script type="text/javascript" src="../Common/js/sdk.js?1=5"></script>
    <script type="text/javascript" src="../Common/js/sdk_data_validation.js"></script>
    <script type="text/javascript" src="../Common/js/sdk_db.js?1=1"></script>
    <script type="text/javascript" src="../Common/js/Bill.js?v=3"></script>
    <script type="text/javascript" src="../Common/js/layer_mobile/layer.js"></script>
    <script type="text/javascript" src="../Common/js/sm.js?1=1"></script>
    <script type="text/javascript" src="../Common/js/sm-extend.js"></script>
    <script type="text/template" id="couponList_Template">
        <div class="yhq-list">
            <div class="card card-list">
                <div class="content-padded grid-demo">
                    <div class="row">
                        <div class="row-left">
                            <span class="fh">￥</span><span class="row-price">{{礼品价格}}</span>
                        </div>
                        <div class="row-right">
                            <div class="title-yxq">
                                <div class="lp-title">油信宝加油券</div>
                                <div class="lp-yxq">领券日期：{{发放日期}}</div>
                            </div>
                           
                            <div class="lp-bz">支付时抵扣</div>
                        </div>
                    </div>
                </div>
            </div>
            <label class="label-checkbox item-content">
                <input type="checkbox" name="my-checkbox" id="{{礼品标识}}" value="{{礼品价格}}" class="checkbox-money" />
                <div class="item-media checkbox-div">
                    <i class="icon icon-form-checkbox"></i>
                </div>
            </label>
            
        </div>
      
    </script>
 
    <style type="text/css">
        .checkbox-money {
            height:4rem;
            line-height:4rem;
        }
        label.label-checkbox input[type="checkbox"]:checked + .item-media i.icon-form-checkbox {
            background-color: #ff8200;
        }
        #selPrice,
        #selNum {
            font-size: 0.75rem;
            font-weight: bold;
            color: #ff8200;
        }

        .picker-items {
            font-size: 1rem;
        }
        .checkbox-div {
            height:4.3rem;
            line-height:4.3rem;
        }
        .icon-form-checkbox {
            left: 10%;
        }
        .page, .page-group {
            background: #fff;
        }

        .title {
            background-color: #ffffff;
            color: #000;
        }
    
        .ykkp {
            width: 100%;
         
        }
        #card_cd {
            top: 0;
            position: absolute;
            height: 9rem;
            line-height: 9rem;
            color: #fff;
            text-align: center;
            width: 100%;
            font-size: 1.5rem;
        }
        .czje {
           -- background: url("../Common/image/wycz/bg_img.png") no-repeat center top;
          --  background-size: 100% 100%;
        }
        .margin-zero {
            margin: 0;
            box-shadow: darkgrey 0rem 0rem 0.3rem 0.1rem
        }
        .cz-czje {
            font-size: 0.75rem;
            font-weight: bold;
        }
        input[type='number'] {
            border: none;
            width: 90%;
            box-sizing: border-box;
            padding-left: 5%;
            font-size: 0.6rem;
            padding-bottom: 0.3rem;
        }
        .border {
            width: 100%;
            height:1px;
            line-height:1px;
            background-color:#eee;
        }
        .yh-title {
            margin-top:0;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .yh-yhjts img{
            height:0.7rem;
        }
        .yh-yhjts {
            font-size:0.6rem;
            height: 0;
            min-height:0rem;
            padding-left:0.3rem;
        }
        .card-header:after {
            background-color: rgba(0, 0, 0, 0)
        }
        .yhjts-img {
            width: 35%;
            font-weight: normal;
        }
        .color-gray {
            color: #e4393c;
        }
        #couponList .card {
            margin: 0;
            box-shadow: none;
            background: url("../Common/image/wycz/img_diyongquan.png") no-repeat left top;
            background-size: 100% 100%;
            width: 80%;
            float: left;
            height: 4.3rem;
        }
        .lp-title {
            padding: 0.3rem 0;
            font-size: 0.65rem;
            font-weight: 600;
            color: #333;
        }

        .title-yxq {
            width: 100%;
            float: left;
            color: #666;
        }
        .lp-bz {
            bottom: 0.15rem;
            position: absolute;
            color: #999;
            font-size:0.6rem;
        }
        .content-padded {
          
            padding-top: 0.2rem;
            width:100%;
        }
        .row {
            margin:0;
        }
        .row-left {
            width: 30.7%;
            float: left;
            text-align: center;
            height: 4rem;
            line-height: 4rem;
            color: #fff;
        }

        .row-right {
            width: 69.3%;
            margin-left: 30%;
            padding-left: 1rem;
        }
        .row-price {
            font-size: 1rem;
            font-family: DIN-Bold;
        }
        .ljlq {
            width: 25%;
            float: left;
            padding-top: 1.6rem;
        }

            .ljlq img {
                width: 80%;
            }
        .lp-yxq {
            font-size: 0.6rem;
            padding-top:0.2rem;
        }
        .content-padded {
            margin:0 auto;
        }
       
        .card-footer {
            margin-top:1rem;
            padding:0
        }
        #cz {
            background-color: #ff8200;
            color: #FFFFFF;
            font-weight: bold;
           -- border-radius:0.3rem;
        }
        .js-button {
           
            background-color: rgba(0,0,0,0);
        }
        .bar-tab:before {
            background-color: rgba(0,0,0,0);
        }
        .content-block-title {
            margin-top:0.5rem;
            font-weight:bold;
        }
       
        yhq-list {
            padding-bottom:0.5rem;
        }
        label.label-checkbox i.icon-form-checkbox {
            border: 1px solid #ff8200;
        }
    </style>
</head>

	<body>
		<div class="page-group">
            <div class="page page-current" id="main">
                <header class="bar bar-nav Color_B1">
                    <a class="icon icon-left pull-left back" style="color: #333;" onclick="$.router.back();"></a>
                    <h1 id="MainPage_Title" class="title" style="color: #333;">充值</h1>
                </header>
                <nav class="bar bar-tab js-button">
                    <a class="tab-item external" style="font-weight: bold;">
                        <span style="font-size: 0.65rem;color: #333;">应支付:</span>
                        <span id="total" style="color: #E4393C;font-size: 0.85rem;">￥0.00</span>
                    </a>
                    <a class="tab-item external" id="cz">结算</a>
                </nav>
                <div id="PageContent" class="content">
                    <div class="card">
                        <div class="card-content" style="padding:0;">
                            <div>
                                <img src="../Common/image/wycz/ykkp.png" class="ykkp" />
                            </div>
                            <div id="card_cd"></div>
                        </div>
                    </div>
                    <div class="border no-yhj"></div>
                    <div class="card margin-zero">
                        <div class="card-content czje">
                            <div class="card-content-inner">
                                <p class="cz-czje">充值金额</p>
                                <p style=" border-bottom: 1px solid #DDDDDD;margin-top:1.7rem" class="je">
                                    <span style="font-size: 0.6rem;font-weight: normal;">￥</span>
                                    <input type="number" id="amount" readonly="readonly" placeholder="请选择金额" />
                                    <div class="container"></div>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="border"></div>

                   <!-- <div class="content-block-title yh-title">优惠</div>-->
                    <div class="content-block-title mode-title bklc-title yjy-title">
                        <a class="icon  pull-right" style="color:#333;"></a>优惠券
                    </div>
                    <div class="yhq-list-box">
                        <div class="card" hidden id="no-dyq">

                            <div class="card-header yh-yhjts">
                                <div class="yhjts-img">
                                    <img src="../Common/image/wycz/no-dyq.png" alt="" />
                                    <span>优惠券</span>
                                </div>
                                <div class="color-gray">无抵用券使用</div>
                            </div>
                        </div>

                        <div class="card" id="dyq">

                            <div class="card-header yh-yhjts">
                                <div class="yhjts-img">
                                    <img src="../Common/image/wycz/no-dyq.png" alt="" />
                                    <span>优惠券</span>
                                </div>
                                <div class="color-gray" id="totalCoupon"></div>
                            </div>
                            <div class="card-content">
                                <div id="couponList"> </div>
                            </div>
                            <div class="card-footer">
                                <label class="label-checkbox" style="padding-right: 0.75rem;">
                                    <input type="checkbox" name="all-checkbox">
                                    <div class="item-media">
                                        <i class="icon icon-form-checkbox"></i>&nbsp;&nbsp;全选
                                    </div>
                                </label>
                                <div>
                                    已选&nbsp;
                                    <span id="selNum">0</span>&nbsp;张,可抵用&nbsp;
                                    <span id="selPrice">0.00</span>&nbsp;元
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
         </div>

        <script type="text/javascript">
            $$.Page_Load = function () {
                $.init();
                var rst = Bill.GetUserCardInfo();
                // 注册过油卡已经分配
                if (rst && rst.Table.length != 0) {
                    this.RegistedCardCD = rst.Table[0].CARD_CD;

                    var startElement = '<span class="card-cd"><span class="card-number">';
                    var endElement = '</span></span>';
                    var showHtml = "";
                    for (var i = 0; i < this.RegistedCardCD.length; i++) {
                        showHtml += startElement + this.RegistedCardCD[i] + endElement;
                    }

                    
                    $('#card_cd').html(showHtml);
                   
                }
                var My = {
                    CardCD: "",
                    RegistedCardCD: "",
                    ApplyRecordId: 0,
                    IMAGES: []
                };
            }
           
            // 结算
            $("#cz").click(function () {
                var num = $("input[type='number']").val();
                if (!num) {
                    layer.open({
                        content: '最低金额不能小于0.01元',
                        skin: 'msg',
                        time: 4
                    });
                    return;
                }
                var discountIDs = [];
                var data = {};
        
                // 通联支付金额以分为单位
                data.allAmount = num;
                var checkBox = $("input[name='my-checkbox']");
                if (checkBox.length > 0) {
                    for (var i = 0; i < checkBox.length; i++) {
                        if ($(checkBox[i]).prop("checked")) {
                            var checkedID = $(checkBox[i]).attr("id");
                            discountIDs.push(checkedID)
                        }
                    }
                    data.discountIDs = discountIDs.join(",");
                } else {
                    data.discountIDs = '';
                }
                data.trxamt = (Number(num) - Number(selPrice)) * 100;
        
                data.appid = "00016005";
                data.body = "在线充值";
                data.remark = "";
                data.orderType = "RechargeOilcard";
                $$.GetWxJsApiParam(data, CallPay);
            });
        
            //调用微信JS api 支付
            var JsApiCall = function (wxJsApiParam) {
                WeixinJSBridge.invoke(
                    'getBrandWCPayRequest',
                    wxJsApiParam, //josn串
                    function (res) {
                        WeixinJSBridge.log(res.err_msg);
                        var msg = "充值成功";
                        if (res.err_msg == "get_brand_wcpay_request:ok") {
                            queryCoupon();
                        } else {
                            msg = "充值失败";
                        }
                        layer.open({
                            content: msg,
                            skin: 'msg',
                            time: 3
                        });
                    });
            }
        
            var CallPay = function (wxJsApiParam) {
                if (typeof WeixinJSBridge == "undefined") {
                    if (document.addEventListener) {
                        document.addEventListener('WeixinJSBridgeReady', JsApiCall(wxJsApiParam), false);
                    } else if (document.attachEvent) {
                        document.attachEvent('WeixinJSBridgeReady', JsApiCall(wxJsApiParam));
                        document.attachEvent('onWeixinJSBridgeReady', JsApiCall(wxJsApiParam));
                    }
                } else {
                    JsApiCall(wxJsApiParam);
                }
            };
        
            // 全选
            var isCheckAll = false;
            var selNum = 0;
            var selPrice = 0;
            $("input[name='all-checkbox']").click(function () {
                var num = Number($("input[type='number']").val());
                if (!num) {
                    layer.open({
                        content: "请选择充值金额",
                        skin: 'msg',
                        time: 3
                    });
                    $(this).prop("checked", false);
                    return
                }
        
                selNum = 0, selPrice = 0;
                if (isCheckAll) {
                    $("input[name='my-checkbox']").each(function () {
                        this.checked = false;
                    });
                    isCheckAll = false;
                } else {
                    $("input[name='my-checkbox']").each(function () {
                        this.checked = true;
                        selNum++;
                        selPrice += Number(this.value);
                    });
                    isCheckAll = true;
                    if ((num - selPrice).toFixed(2) <= 0) {
                        layer.open({
                            content: "优惠金额不能大于等于输入金额",
                            skin: 'msg',
                            time: 3
                        });
                        selNum = 0, selPrice = 0;
                        $(this).prop("checked", false);
                        $("input[name='my-checkbox']").prop("checked", false);
                        isCheckAll = false;
                        return
                    }
                }
                var total = (num - selPrice).toFixed(2);
                $("#total").text("￥" + total);
                $("#selNum").text(selNum);
                $("#selPrice").text(selPrice.toFixed(2));
            });
        
            // 优惠券复选
            $("#couponList").on("click", "input[name='my-checkbox']", function () {
                var num = Number($("input[type='number']").val());
                if (!num) {
                    layer.open({
                        content: "请选择充值金额",
                        skin: 'msg',
                        time: 3
                    });
                    $(this).prop("checked", false);
                    return
                }
        
                var isChecked = $(this).prop("checked");
                if (isChecked == true) {
                    selNum++;
                    selPrice += Number($(this).val());
                    if ((num - selPrice).toFixed(2) <= 0) {
                        layer.open({
                            content: "优惠金额不能大于等于输入金额",
                            skin: 'msg',
                            time: 3
                        });
                        selNum--;
                        selPrice -= Number($(this).val());
                        $(this).prop("checked", false);
                        return
                    }
                } else {
                    selNum = selNum == 0 ? 0 : selNum - 1;
                    selPrice -= Number($(this).val());
                }
                var checkedArr = $("input[name='my-checkbox']").not(function () {
                    return !this.checked
                });
        
                if (checkedArr.length == 0) {
                    $("input[name='all-checkbox']").prop("checked", false);
                }
        
                var total = (num - selPrice).toFixed(2);
                $("#total").text("￥" + total);
                $("#selNum").text(selNum);
                $("#selPrice").text(selPrice.toFixed(2));
            });
        
            // 查询优惠券
            function queryCoupon() {
                var proc = "支付_可用优惠券列表 " + Bill.userId;
                var rst = $$.JSONDB.Query(proc).Table;
                if (rst.length > 0) {
                    $(".no-yhj").hide();
                    for (var i = 0; i < rst.length; i++) {
                        rst[i].礼品价格 = rst[i].礼品价格.toFixed(2);
                        var time = rst[i].发放日期;
                        rst[i].发放日期 = time.substr(0, 4) + "-" + time.substr(4, 2) + "-" + time.substr(6, 2)
                    }
                    $("#couponList").text("");
                    $$.Fill("#couponList", rst);
                    $("#totalCoupon").text(rst.length + "张券可用/共" + rst.length + "张券");
                    $("#dyq").show();
                    $("#selNum").text("0");
                    $("#selPrice").text("0.00");
                } else {
                    $("#dyq").text("");
                    $("#no-dyq").show();
                }
                $("#total").text("￥0.00")
                $("#amount").val("");
            }
        
            queryCoupon();
        
            // 输入框失去焦点
            $("input[type='number']").bind('input propertychange', function () {
                var num = $(this).val();
                var total = Number(num).toFixed(2);
                $("#total").text("￥" + total);
            });
        
            // 金额选择
            var amountShow = [];
            for (var i = 1; i <= 20; i++) {
                var obj = {
                    "id": i,
                    "value": i * 100
                }
                amountShow.push(obj);
            }
        
            for (var j = 3; j <= 10; j++) {
                var obj = {
                    "id": j * 10,
                    "value": j * 1000
                }
                amountShow.push(obj);
            }
        
            var showBankDom = document.querySelector('#amount');
            var total = document.querySelector("#total");
            showBankDom.addEventListener('click', function () {
                var amountId = showBankDom.dataset['id'];
                var bankSelect = new IosSelect(1, [amountShow], {
                    container: '.container',
                    title: '请选择充值金额',
                    itemHeight: 50,
                    itemShowCount: 3,
                    oneLevelId: amountId,
                    callback: function (selectOneObj) {
                        showBankDom.value = selectOneObj.value;
                        var amount = (Number(selectOneObj.value)).toFixed(2);
                        total.innerHTML = "￥" + amount;
                        showBankDom.dataset['id'] = selectOneObj.id;
                        showBankDom.dataset['value'] = selectOneObj.value;
                    }
                });
            });
        </script>
</body>

</html>